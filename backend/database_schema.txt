-- Database Schema for OrgAttendance AI

CREATE DATABASE IF NOT EXISTS org_attendance_db;
USE org_attendance_db;

-- 1. Users Table
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    employee_id VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) DEFAULT 'EMPLOYEE', -- 'ADMIN' or 'EMPLOYEE'
    department VARCHAR(50),
    avatar_url TEXT,
    join_date DATE,
    wallet_balance DECIMAL(10, 2) DEFAULT 0.00,
    hourly_rate DECIMAL(10, 2) DEFAULT 0.00,
    daily_rate DECIMAL(10, 2) DEFAULT 0.00,
    monthly_rate DECIMAL(10, 2) DEFAULT 0.00,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. Attendance Table
CREATE TABLE IF NOT EXISTS attendance (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    date DATE NOT NULL,
    check_in_time VARCHAR(20),
    check_out_time VARCHAR(20),
    status VARCHAR(20) DEFAULT 'PRESENT', -- 'PRESENT', 'LATE', 'ABSENT', 'HALF_DAY'
    photo_url TEXT, -- For verification
    location VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 3. Projects Table
CREATE TABLE IF NOT EXISTS projects (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    department VARCHAR(50),
    assigned_to INT, -- Project Lead (User ID)
    author_id INT, -- Creator (User ID)
    team_ids JSON, -- Array of User IDs e.g. [1, 2, 3]
    status VARCHAR(20) DEFAULT 'ACTIVE', -- 'ACTIVE', 'COMPLETED', 'ON_HOLD'
    progress INT DEFAULT 0,
    deadline DATE,
    tags JSON, -- Array of strings e.g. ["URGENT", "CLIENT"]
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (assigned_to) REFERENCES users(id) ON DELETE SET NULL
);

-- 4. Tasks Table
CREATE TABLE IF NOT EXISTS tasks (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    status VARCHAR(20) DEFAULT 'TODO', -- 'TODO', 'IN_PROGRESS', 'DONE'
    priority VARCHAR(20) DEFAULT 'MEDIUM', -- 'HIGH', 'MEDIUM', 'LOW'
    due_date DATE,
    assignee_ids JSON, -- Array of User IDs
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

-- 5. Task Comments Table
CREATE TABLE IF NOT EXISTS task_comments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    task_id INT NOT NULL,
    user_id INT NOT NULL,
    text TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 6. Leaves Table
CREATE TABLE IF NOT EXISTS leaves (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    type VARCHAR(50) NOT NULL, -- 'SICK', 'VACATION', 'PERSONAL', etc.
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    days FLOAT NOT NULL,
    reason TEXT,
    status VARCHAR(20) DEFAULT 'PENDING', -- 'PENDING', 'APPROVED', 'REJECTED'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 7. Transactions Table (Wallet)
CREATE TABLE IF NOT EXISTS transactions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    type VARCHAR(10) NOT NULL, -- 'credit', 'debit'
    amount DECIMAL(10, 2) NOT NULL,
    title VARCHAR(255) NOT NULL,
    date VARCHAR(50), -- Storing as string for display flexibility or use DATE
    tags JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 8. Payslips Table
CREATE TABLE IF NOT EXISTS payslips (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    month VARCHAR(20) NOT NULL,
    year INT NOT NULL,
    period_start DATE,
    period_end DATE,
    generated_date DATE,
    basic_salary DECIMAL(10, 2),
    total_earnings DECIMAL(10, 2),
    total_deductions DECIMAL(10, 2),
    net_salary DECIMAL(10, 2),
    status VARCHAR(20) DEFAULT 'PAID',
    items_json JSON, -- Stores full breakdown structure
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 9. Roles Table (RBAC)
CREATE TABLE IF NOT EXISTS roles (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL, -- e.g., 'ADMIN', 'HR', 'EMPLOYEE'
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 10. Permissions Table (RBAC)
CREATE TABLE IF NOT EXISTS permissions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL, -- e.g., 'user.create', 'report.view'
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 11. Role_Permissions Table (RBAC Mapping)
CREATE TABLE IF NOT EXISTS role_permissions (
    role_id INT NOT NULL,
    permission_id INT NOT NULL,
    PRIMARY KEY (role_id, permission_id),
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE
);

-- --- SEED DATA (Optional) ---

-- Insert Default Roles
INSERT INTO roles (name, description) VALUES 
('ADMIN', 'Administrator with full access'),
('EMPLOYEE', 'Standard employee access'),
('HR', 'Human Resources manager');

-- Insert Default Permissions
INSERT INTO permissions (name, description) VALUES 
('user.create', 'Can create new users'),
('user.view', 'Can view user details'),
('user.edit', 'Can edit user details'),
('user.delete', 'Can delete users'),
('attendance.view', 'Can view attendance records'),
('attendance.edit', 'Can edit attendance records'),
('payroll.manage', 'Can manage payroll and wallet'),
('project.create', 'Can create projects');

-- Map Permissions to ADMIN (Give all permissions)
INSERT INTO role_permissions (role_id, permission_id) 
SELECT 1, id FROM permissions;

-- Map Permissions to EMPLOYEE (View Only)
INSERT INTO role_permissions (role_id, permission_id) 
SELECT 2, id FROM permissions WHERE name IN ('user.view', 'attendance.view');
